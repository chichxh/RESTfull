@using RESTfull.Domain.Entities

<div class="direction-section-tree">
    @if (Directions == null || !Directions.Any())
    {
        <div class="alert alert-info">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
    }
    else
    {
        <div class="accordion" id="directionsAccordion">
            @foreach (var direction in Directions)
            {
                var directionId = $"direction-{direction.Id}";
                var hasSections = direction.Sections != null && direction.Sections.Any();

                <div class="accordion-item mb-2">
                    <h2 class="accordion-header" id="heading-@direction.Id">
                        <button class="accordion-button @(direction.Id == ExpandedDirectionId ? "" : "collapsed")" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#@directionId" 
                                aria-expanded="@(direction.Id == ExpandedDirectionId ? "true" : "false")"
                                @onclick="() => ToggleDirection(direction.Id)">
                            <div class="w-100 d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@direction.Index - @direction.Name</strong>
                                    @if (hasSections)
                                    {
                                        <span class="badge bg-secondary ms-2">@direction.Sections.Count —Å–µ–∫—Ü–∏–π</span>
                                    }
                                </div>
                                <div class="text-muted small me-3">
                                    @if (direction.StartTime.HasValue || direction.EndTime.HasValue)
                                    {
                                        <span>@(direction.StartTime?.ToString("dd.MM.yyyy HH:mm") ?? "?") - @(direction.EndTime?.ToString("dd.MM.yyyy HH:mm") ?? "?")</span>
                                    }
                                    @if (direction.Venue != null)
                                    {
                                        <span class="ms-2">üìç @direction.Venue.Name</span>
                                    }
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="@directionId" 
                         class="accordion-collapse collapse @(direction.Id == ExpandedDirectionId ? "show" : "")" 
                         aria-labelledby="heading-@direction.Id">
                        <div class="accordion-body">
                            @if (!string.IsNullOrWhiteSpace(direction.Description))
                            {
                                <p class="mb-3">@direction.Description</p>
                            }

                            @if (hasSections)
                            {
                                <h6 class="mb-3">–°–µ–∫—Ü–∏–∏:</h6>
                                <div class="list-group">
                                    @foreach (var sectionItem in direction.Sections)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">@sectionItem.Index - @sectionItem.Name</h6>
                                                    @if (!string.IsNullOrWhiteSpace(sectionItem.Description))
                                                    {
                                                        <p class="mb-1 text-muted small">@sectionItem.Description</p>
                                                    }
                                                    <div class="small text-muted">
                                                        @if (sectionItem.StartTime.HasValue || sectionItem.EndTime.HasValue)
                                                        {
                                                            <span>@(sectionItem.StartTime?.ToString("dd.MM.yyyy HH:mm") ?? "?") - @(sectionItem.EndTime?.ToString("dd.MM.yyyy HH:mm") ?? "?")</span>
                                                        }
                                                        @if (sectionItem.Venue != null)
                                                        {
                                                            <span class="ms-2">üìç @sectionItem.Venue.Name</span>
                                                        }
                                                    </div>
                                                </div>
                                                <div>
                                                    @if (OnViewSection.HasDelegate)
                                                    {
                                                        <button class="btn btn-sm btn-outline-info" @onclick="() => OnViewSection.InvokeAsync(sectionItem)">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                                                    }
                                                    @if (OnEditSection.HasDelegate)
                                                    {
                                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => OnEditSection.InvokeAsync(sectionItem)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                                    }
                                                    @if (OnDeleteSection.HasDelegate)
                                                    {
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => OnDeleteSection.InvokeAsync(sectionItem)">–£–¥–∞–ª–∏—Ç—å</button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light">
                                    <small>–°–µ–∫—Ü–∏–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</small>
                                </div>
                            }

                            <div class="mt-3">
                                @if (OnEditDirection.HasDelegate)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="() => OnEditDirection.InvokeAsync(direction)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                                }
                                @if (OnAddSection.HasDelegate)
                                {
                                    <button class="btn btn-sm btn-success" @onclick="() => OnAddSection.InvokeAsync(direction)">–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public IEnumerable<Direction> Directions { get; set; } = Enumerable.Empty<Direction>();

    [Parameter]
    public EventCallback<Direction> OnViewDirection { get; set; }

    [Parameter]
    public EventCallback<Direction> OnEditDirection { get; set; }

    [Parameter]
    public EventCallback<Section> OnViewSection { get; set; }

    [Parameter]
    public EventCallback<Section> OnEditSection { get; set; }

    [Parameter]
    public EventCallback<Section> OnDeleteSection { get; set; }

    [Parameter]
    public EventCallback<Direction> OnAddSection { get; set; }

    private int? ExpandedDirectionId { get; set; }

    private void ToggleDirection(int directionId)
    {
        ExpandedDirectionId = ExpandedDirectionId == directionId ? null : directionId;
    }
}

